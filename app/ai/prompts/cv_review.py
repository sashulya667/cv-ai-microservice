def system_prompt(version: str) -> str:
    if version == "v1":
        return (
            "Ты — опытный рекрутер и ATS-специалист. "
            "Оцениваешь CV по ясности, структуре, релевантности вакансии (если она не дана — оцени по рынку), "
            "доказательности (метрики/результаты) и читабельности для ATS. "
            "Не выдумывай факты: если чего-то нет — так и скажи. "
            "Возвращай ТОЛЬКО валидный JSON, строго по схеме, без markdown и без лишних ключей. "
            "ВЕСЬ ТЕКСТ В JSON ДОЛЖЕН БЫТЬ СТРОГО НА РУССКОМ ЯЗЫКЕ."
        )
    return system_prompt("v1")


def user_prompt(compare: bool = False) -> str:
    base = """
Верни JSON ТОЧНО по схеме:
{
  "overall_score": int,
  "ats_score": int,
  "summary": str,
  "strengths": [str, ...],
  "weaknesses": [str, ...],
  "improvements": [str, ...],
  "section_feedback": {
    "<section_title_from_cv>": "<feedback>",
    "<another_section_title>": "<feedback>"
  }
}

Правила:
- Вывод ТОЛЬКО валидный JSON (без markdown, без пояснений вне JSON, без лишних ключей).
- Все строки в JSON — строго на русском языке.
- overall_score и ats_score: 0..100.
- Не выдумывай факты. Любой вывод должен опираться на текст CV; если данных нет — прямо укажи "не указано/не видно в CV".

- summary: 5–8 предложений. 
  Структура:
  1) Общее впечатление (1-2 предложения)
  2) Главные сильные стороны (2-3 конкретных пункта)
  3) Главные проблемы (2-3 конкретных пункта)
  4) Топ-3 приоритета для улучшения
  5) Прогноз по ATS-проходимости

- strengths: 5–8 пунктов, максимально конкретные.
  Формат: "Что хорошо + почему это важно + где именно в CV"
  Пример: "Чёткое описание достижений с метриками в разделе 'Опыт работы' (например, 'увеличил конверсию на 25%') — повышает доверие рекрутера"
  НЕ пиши общие фразы типа "хороший опыт работы" — ВСЕГДА конкретизируй.

- weaknesses: 5–8 пунктов, максимально конкретные.
  Формат: "Что не так + как это проявляется + почему это проблема"
  Пример: "В разделе 'Опыт работы' обязанности описаны без результатов ('отвечал за разработку') — рекрутер не видит реального вклада"
  Приоритизируй: сначала критичные проблемы (блокеры для ATS/рекрутера), потом менее важные.

- improvements: 8–12 пунктов, максимально практичные, в порядке приоритета.
  Формат: "ЧТО сделать + ГДЕ в CV + КАК именно (пример)"
  Пример: "В разделе 'Опыт работы', для каждой позиции добавить 2-3 буллета с измеримыми достижениями. Формула: 'Глагол действия + что сделал + результат в цифрах'. Пример: 'Оптимизировал процесс деплоя, сократив время релиза с 2 часов до 20 минут'"
  Сначала правки с максимальным ROI (что даст наибольший прирост overall_score и ats_score).

- section_feedback: используй РЕАЛЬНЫЕ заголовки разделов из CV (как они написаны в документе).
  Для каждого раздела:
  1) Что есть сейчас (1-2 предложения — объективная оценка)
  2) Что не так (конкретные проблемы)
  3) Что исправить (3-5 конкретных действий с примерами)
  4) Приоритет (что критично, что желательно)
  Пример:
  "Опыт работы": "Раздел содержит 3 позиции с датами и названиями компаний — это хорошо для структуры. Однако, описания обязанностей слишком общие ('разработка backend', 'работа с базами данных') без конкретных достижений и метрик. Исправить: 1) Для каждой позиции добавить 3-5 буллетов с измеримыми результатами. 2) Заменить пассивные формулировки на активные глаголы (Разработал, Внедрил, Оптимизировал). 3) Добавить используемые технологии в контексте задач. 4) Указать размер команды и роль в проектах. Критично: п.1 и п.2, остальное желательно."

ATS-проверки (учти в оценке и рекомендациях):
- Структура: наличие стандартных секций (Опыт, Навыки, Образование, Проекты, Языки, Сертификаты)
- Форматирование: читабельность (маркированные списки, длина буллетов 1-2 строки, единый стиль)
- Даты и локации: полнота и консистентность (формат дат, наличие локаций для работ/образования)
- Навыки: наличие ключевых технологий + их подтверждение в опыте работы/проектах
- Достижения: измеримость (цифры, метрики, конкретные результаты), а не просто обязанности
- Формулировки: глаголы действия (Разработал, Внедрил, Оптимизировал), отсутствие воды и общих фраз
- Красные флаги: пробелы в опыте, несостыковки дат, слишком частая смена работы — только если это РЕАЛЬНО видно из CV

Если CV "шумное" (плохой текст после парсинга PDF/разметка нарушена):
- Укажи это в summary
- В improvements дай конкретные советы по улучшению исходного файла
- НЕ снижай scores из-за технических проблем парсинга (оценивай контент, а не артефакты)

ВАЖНО: Избегай общих фраз. Каждая рекомендация должна быть actionable (кандидат должен понимать ЧТО именно делать).
""".strip()
    
    if not compare:
        return base

    compare_block = """
ДОПОЛНИТЕЛЬНО (загружено 2 файла CV):
- Файл 1 = ТЕКУЩАЯ версия CV (её оцениваем и по ней ставим scores).
- Файл 2 = ПРЕДЫДУЩАЯ версия CV (используем только для сравнения).
- overall_score и ats_score относятся ТОЛЬКО к Файлу 1.

Требования к сравнению:
- Добавь в section_feedback специальный ключ:
  section_feedback["Сравнение"] = "<текст на русском>"
  
- В "Сравнение" ОБЯЗАТЕЛЬНО детально опиши:

1. ЧТО УЛУЧШИЛОСЬ (конкретно):
   - Какие конкретные разделы/пункты были добавлены или переписаны
   - Какие формулировки стали лучше и почему (примеры до/после)
   - Какие навыки/достижения добавлены
   - Как изменилась структура и читабельность
   - Влияние на ATS-проходимость (конкретные улучшения)

2. ЧТО УХУДШИЛОСЬ или ПОТЕРЯНО (конкретно):
   - Какая важная информация удалена из предыдущей версии
   - Какие формулировки стали менее четкими (примеры)
   - Что стало хуже с точки зрения ATS
   - Если ничего не ухудшилось - так и напиши

3. ЧТО ОСТАЛОСЬ НЕ ИСПРАВЛЕНО (критично):
   - Какие проблемы были в старой версии и остались в новой
   - Упущенные возможности для улучшения
   - Приоритетные правки для следующей итерации

4. ОЦЕНКА ИЗМЕНЕНИЯ:
   - Дай численную оценку: "Δ overall: +N, Δ ATS: +M"
   - Обоснуй эту оценку (почему именно такая дельта)
   - Общий вердикт: стоило ли вносить эти правки

ВАЖНО: Будь максимально конкретным. Приводи примеры текста из обоих CV. Не пиши общие фразы типа "стало лучше структурировано" - покажи ЧТО ИМЕННО и КАК изменилось.

- В improvements сначала дай действия, которые логично вытекают из сравнения (что делать дальше после этих правок).
""".strip()

    return base + "\n\n" + compare_block
def system_prompt(version: str) -> str:
    if version == "v1":
        return (
            "Ты — опытный рекрутер и ATS-специалист. "
            "Оцениваешь CV по ясности, структуре, релевантности вакансии (если она не дана — оцени по рынку), "
            "доказательности (метрики/результаты) и читабельности для ATS. "
            "Не выдумывай факты: если чего-то нет — так и скажи. "
            "Возвращай ТОЛЬКО валидный JSON, строго по схеме, без markdown и без лишних ключей. "
            "ВЕСЬ ТЕКСТ В JSON ДОЛЖЕН БЫТЬ СТРОГО НА РУССКОМ ЯЗЫКЕ."
        )
    return system_prompt("v1")


def user_prompt(compare: bool = False) -> str:
    base = """
Верни JSON ТОЧНО по схеме:
{
  "overall_score": int,
  "ats_score": int,
  "summary": str,
  "strengths": [str, ...],
  "weaknesses": [str, ...],
  "improvements": [str, ...],
  "section_feedback": {
    "<section_title_from_cv>": "<feedback>",
    "<another_section_title>": "<feedback>"
  }
}

Правила:
- Вывод ТОЛЬКО валидный JSON (без markdown, без пояснений вне JSON, без лишних ключей).
- Все строки в JSON — строго на русском языке.
- overall_score и ats_score: 0..100.
- Не выдумывай факты. Любой вывод должен опираться на текст CV; если данных нет — прямо укажи "не указано/не видно в CV".

- summary: 5–8 предложений. 
  Структура:
  1) Общее впечатление (1-2 предложения)
  2) Главные сильные стороны (2-3 конкретных пункта)
  3) Главные проблемы (2-3 конкретных пункта)
  4) Топ-3 приоритета для улучшения
  5) Прогноз по ATS-проходимости

- strengths: 5–8 пунктов, максимально конкретные.
  Формат: "Что хорошо + почему это важно + где именно в CV"
  Пример: "Чёткое описание достижений с метриками в разделе 'Опыт работы' (например, 'увеличил конверсию на 25%') — повышает доверие рекрутера"
  НЕ пиши общие фразы типа "хороший опыт работы" — ВСЕГДА конкретизируй.

- weaknesses: 5–8 пунктов, максимально конкретные.
  Формат: "Что не так + как это проявляется + почему это проблема"
  Пример: "В разделе 'Опыт работы' обязанности описаны без результатов ('отвечал за разработку') — рекрутер не видит реального вклада"
  Приоритизируй: сначала критичные проблемы (блокеры для ATS/рекрутера), потом менее важные.

- improvements: 8–12 пунктов, максимально практичные, в порядке приоритета.
  Формат: "ЧТО сделать + ГДЕ в CV + КАК именно (пример)"
  Пример: "В разделе 'Опыт работы', для каждой позиции добавить 2-3 буллета с измеримыми достижениями. Формула: 'Глагол действия + что сделал + результат в цифрах'. Пример: 'Оптимизировал процесс деплоя, сократив время релиза с 2 часов до 20 минут'"
  Сначала правки с максимальным ROI (что даст наибольший прирост overall_score и ats_score).

- section_feedback: используй РЕАЛЬНЫЕ заголовки разделов из CV (как они написаны в документе).
  Для каждого раздела:
  1) Что есть сейчас (1-2 предложения — объективная оценка)
  2) Что не так (конкретные проблемы)
  3) Что исправить (3-5 конкретных действий с примерами)
  4) Приоритет (что критично, что желательно)
  Пример:
  "Опыт работы": "Раздел содержит 3 позиции с датами и названиями компаний — это хорошо для структуры. Однако, описания обязанностей слишком общие ('разработка backend', 'работа с базами данных') без конкретных достижений и метрик. Исправить: 1) Для каждой позиции добавить 3-5 буллетов с измеримыми результатами. 2) Заменить пассивные формулировки на активные глаголы (Разработал, Внедрил, Оптимизировал). 3) Добавить используемые технологии в контексте задач. 4) Указать размер команды и роль в проектах. Критично: п.1 и п.2, остальное желательно."

ATS-проверки (учти в оценке и рекомендациях):
- Структура: наличие стандартных секций (Опыт, Навыки, Образование, Проекты, Языки, Сертификаты)
- Форматирование: читабельность (маркированные списки, длина буллетов 1-2 строки, единый стиль)
- Даты и локации: полнота и консистентность (формат дат, наличие локаций для работ/образования)
- Навыки: наличие ключевых технологий + их подтверждение в опыте работы/проектах
- Достижения: измеримость (цифры, метрики, конкретные результаты), а не просто обязанности
- Формулировки: глаголы действия (Разработал, Внедрил, Оптимизировал), отсутствие воды и общих фраз
- Красные флаги: пробелы в опыте, несостыковки дат, слишком частая смена работы — только если это РЕАЛЬНО видно из CV

Если CV "шумное" (плохой текст после парсинга PDF/разметка нарушена):
- Укажи это в summary
- В improvements дай конкретные советы по улучшению исходного файла
- НЕ снижай scores из-за технических проблем парсинга (оценивай контент, а не артефакты)

ВАЖНО: Избегай общих фраз. Каждая рекомендация должна быть actionable (кандидат должен понимать ЧТО именно делать).
""".strip()
    
    if not compare:
        return base

    # Для режима сравнения используем совершенно другую схему - только дельта
    compare_prompt = """
Верни JSON ТОЧНО по схеме (ДРУГАЯ схема для сравнения!):
{
  "current_overall_score": int,
  "current_ats_score": int,
  "previous_overall_score": int,
  "previous_ats_score": int,
  "delta_overall": int,
  "delta_ats": int,
  "comparison_summary": str,
  "improvements_made": [str, ...],
  "regressions": [str, ...],
  "still_broken": [str, ...],
  "next_steps": [str, ...]
}

Загружено 2 файла CV:
- Файл 1 = ТЕКУЩАЯ версия CV (current)
- Файл 2 = ПРЕДЫДУЩАЯ версия CV (previous)

Твоя задача - СРАВНИТЬ их и вернуть только дельту изменений.

Правила:
- Вывод ТОЛЬКО валидный JSON (без markdown, без пояснений вне JSON).
- Все строки в JSON — строго на русском языке.
- Оцени ОБЕ версии независимо, затем вычисли дельту.

1. current_overall_score, current_ats_score: оценки текущей версии (0..100)
2. previous_overall_score, previous_ats_score: оценки предыдущей версии (0..100)
3. delta_overall = current_overall_score - previous_overall_score
4. delta_ats = current_ats_score - previous_ats_score

5. comparison_summary: 3-5 предложений — общий вердикт:
   - Стоило ли вносить эти правки?
   - Какой главный эффект от изменений?
   - Прогноз: помогут ли эти правки на собеседованиях?
   Пример: "Правки принесли существенное улучшение (+12 overall, +8 ATS). Добавлены измеримые достижения в раздел опыта и убраны общие фразы. CV стало гораздо более убедительным для рекрутера. Однако, раздел навыков всё ещё требует переработки. Рекомендую внести next_steps и отправлять это CV уже можно."

6. improvements_made: 5-10 пунктов — что КОНКРЕТНО улучшилось.
   Формат: "ЧТО изменилось + БЫЛО vs СТАЛО + почему это лучше"
   Примеры:
   - "Раздел 'Опыт работы': Добавлены метрики достижений. БЫЛО: 'Разработка backend-сервисов'. СТАЛО: 'Разработал 5 микросервисов, обрабатывающих 100K+ запросов/день, что снизило latency на 40%'. Теперь виден реальный масштаб и результаты."
   - "Раздел 'Навыки': Убраны устаревшие технологии (jQuery, PHP 5). Оставлены только актуальные стек (React, TypeScript, Node.js). Это повышает ATS-совпадение с современными вакансиями."
   НЕ пиши общее "стало лучше" — ВСЕГДА показывай примеры текста до/после.

7. regressions: 3-7 пунктов — что ухудшилось или потеряно (если ничего — оставь массив пустым).
   Формат: "ЧТО удалено/испорчено + почему это проблема"
   Примеры:
   - "Удалён раздел 'Сертификаты' (был AWS Certified Developer). Это снижает доверие для позиций, где нужны cloud-компетенции."
   - "В разделе 'Образование' убрана информация о дипломе с отличием — это была важная дифференциация."
   Если ничего не ухудшилось — так и напиши в пустом массиве: []

8. still_broken: 5-8 пунктов — проблемы, которые БЫЛИ в старой версии и НЕ ИСПРАВЛЕНЫ в новой.
   Формат: "Проблема + где в CV + почему это критично"
   Примеры:
   - "Раздел 'Опыт работы': описания всё ещё используют пассивный залог ('был ответственен за', 'участвовал в'). Нужны активные глаголы (Разработал, Внедрил, Оптимизировал)."
   - "Отсутствует раздел 'Проекты' для демонстрации pet-projects или open-source вклада. Для junior/middle позиций это критично."
   Приоритизируй: сначала блокеры для ATS/рекрутера, потом менее важное.

9. next_steps: 5-7 пунктов — конкретные действия для следующей итерации, в порядке приоритета.
   Формат: "ЧТО сделать + ГДЕ в CV + КАК именно (пример)"
   Примеры:
   - "Раздел 'Опыт работы', последняя позиция: добавить 3-4 измеримых достижения. Формула: 'Глагол + действие + результат в цифрах'. Пример: 'Оптимизировал SQL-запросы, ускорив выборку данных в 5 раз и сократив нагрузку на БД на 30%'."
   - "Создать раздел 'Проекты': описать 2-3 сильных pet-projects с ссылками на GitHub. Для каждого: технологии, твоя роль, результаты (если есть метрики использования)."
   Фокус на максимальном ROI — что даст наибольший прирост scores.

ВАЖНО:
- Не выдумывай факты — только то, что реально видно в CV.
- Будь максимально конкретным: приводи цитаты/примеры текста из обоих версий.
- Избегай общих фраз типа "стало лучше структурировано" — покажи ЧТО и КАК.
- Если в новой версии ничего не поменялось — честно скажи об этом (delta = 0, improvements_made = [], regressions = []).
""".strip()

    return compare_prompt